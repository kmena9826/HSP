@model CS_HOSPITALARIO_Front_end.Models.ViewModel.ListaImagenViewModel
@{
    ViewBag.Title = "Historial de Imagenología";
    ViewBag.Modulo = "mImagenologia";
}

<h2></h2>
<script src="~/Scripts/vendor.js"></script>
<link href="~/Content/dx.common.css" rel="stylesheet" />
<link href="~/Content/dx.light.css" rel="stylesheet" />
<link href="~/Content/animate.css" rel="stylesheet" />
<style>
    [data-notify="progressbar"] {
        margin-bottom: 0px;
        position: absolute;
        bottom: 0px;
        left: 0px;
        width: 100%;
        height: 5px;
    }
</style>
<div class="row m-0 gap-20 masonry pos-r">
    <div class="masonry-item w-100">
        <div class="row gap-20">
            <div class="masonry-item col-md-12 col-sm-12">
                <div class="bd bgc-white">
                    <div class="layers">
                        <div class="ta-c w-100 p-10">
                            <h4 class="float-left"><span class="color-secondary-h text-uppercase">@ViewBag.Title</span></h4>
                            <nav class="float-right m-0" aria-label="breadcrumb">
                                <ol class="breadcrumb bg-color-blanco">
                                    <li class="breadcrumb-item"><a href="@Url.Action("Index","Home")">Principal</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Imagenología</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<div class="row m-0 gap-20 masonry pos-r">
    <div class="masonry-item w-100">
        <div class="row gap-20">
            <div class="masonry-item col-md-12 col-sm-12">
                <div class="bd bgc-white">
                    <div class="layers">
                        <div class="ta-c w-100 p-10">
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <div class="col-md-1">
                                        <label> Desde</label>
                                    </div>

                                    <div class="col-md-5">
                                        @Html.TextBoxFor(model => model.DESDE, "{0:yyyy-MM-dd}", new { @class = "form-control", @type = "date" })
                                    </div>

                                </div>
                                <div class="form-group col-md-6">
                                    <div class="col-md-1">
                                        <label> Hasta</label>
                                    </div>

                                    <div class="col-md-5">
                                        @Html.TextBoxFor(model => model.HASTA, "{0:yyyy-MM-dd}", new { @class = "form-control", @type = "date" })
                                    </div>


                                </div>
                                <div class="form-group">
                                    <div class="col-md-offset-8 col-md-10">
                                        @*<input id="Filtrar" type="button" value="Filtrar" class="btn btn-success fa fa-save" />*@
                                        <button class="btn btn-primary" type="button" id="Filtrar"><i class="fa fa-search-plus"></i> Filtro</button>
                                    </div>
                                </div>

                                <div id="gridLista"></div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>




@section scripts
{
    <script src="~/Scripts/dx.all.js"></script>
    <script src="~/Scripts/bootstrap-notify.js"></script>
    <script>
        $(document).ready(function () {

            CargarGrid();

            $('#Filtrar').click(function () {

                CargarGrid();

            });

        });
        function CargarGrid() {

            var data = {
                desde: $('#DESDE').val().trim(),
                hasta: $('#HASTA').val().trim()
            }

           $.ajax({
                type: "POST",
                 url: '@Url.Action("GetListaTrabajo_Hist")',
                contentType: "application/json",
                dataType: "json",
                data: JSON.stringify(data),
                success: function (data) {
                    var fillData = data.Lista;
                    var dataGrid = $("#gridLista").dxDataGrid({
                        filterRow: { visible: false },
                        dataSource: fillData,

                        keyExpr: "ID",
                        sorting: {
                            mode: "multiple"
                        },

                        paging: {
                            pageSize: 30
                        },
                        pager: {
                            showPageSizeSelector: true,
                            allowedPageSizes: [10, 20, 50],
                            showInfo: true
                        },
                        filterRow: {
                            visible: true
                        },
                        searchPanel: {
                            visible: true,
                            width: 340,
                            placeholder: "Search..."
                        },
                        loadPanel: {
                            enabled: true
                        },
                        showBorders: true,
                        columns: [
                            {
                                dataField: "FECHA_REGISTRO",
                                caption: "Fecha Registro",
                                dataType: "date",
                                alignment: "center"
                            },
                            {
                                dataField: "ESTADO",
                                caption: "Estado",
                                alignment: "center"
                            },
                            {
                                dataField: "PRIORIDAD",
                                caption: "Prioridad",
                                alignment: "center"
                            },
                            {
                                dataField: "PROCEDIMIENTO",
                                caption: "Procedimiento",

                                alignment: "center"
                            },
                            {
                                dataField: "PACIENTE",
                                caption: "Paciente",
                                alignment: "center"
                            },
                            {
                                dataField: "ADMISION",
                                caption: "Admisión",
                                alignment: "center"
                            },
                            {
                                dataField: "NOMBRE",
                                caption: "Nombre",
                                alignment: "center"
                            },
                            {
                                dataField: "APELLIDO",
                                caption: "Apellido",
                                alignment: "center"
                            },

                            {
                                alignment: "center",
                                cellTemplate: function (container, cellInfo) {

                                    //$("<a>", { "class": "btn btn-success fa fa-flag", "href": "javascript:void(0); onclick=Lectura('" + cellInfo.data.ID+"');"  , "text": "" }).appendTo(container);

                                    $("<a>", { "class": "btn btn-info fa fa-file", "href": "javascript:void(0); onclick=Transcripcion('" + cellInfo.data.ID + "');", "text": "" }).appendTo(container);

                                   
                                    $("<a>", { "class": "btn btn-danger fa fa-times", "href": "javascript:void(0); onclick=Anular('" + cellInfo.data.ID + "','" + cellInfo.data.PEDIDO + "');", "text": "" }).appendTo(container);
                                }
                            }
                        ]

                    }).dxDataGrid("instance");
                }, error: function (xhr, status, error) {
                    alert(status);
                }
            });

        }


        function InsertarTotalImagen(pedido) {
            console.log(pedido);
            $.ajax({
                type: "POST",
                url: '/Admision/MontoPedidoImagen',
                data: JSON.stringify({ pedido: pedido }),
                dataType: "JSON",
                contentType: "application/json",
                success: function (data) {
                    if (data.status) {
                        $.notify({ message: 'Se actualizo el pedido' }, { type: 'success' });
                        $.notify({ message: 'Se anulo la orden' }, { type: 'success' });
                        CargarGrid();
                        //  location.reload();
                    }
                },
                error: function () {
                    $.notify({ message: 'Error al actualizar el total del pedido' }, { type: 'danger' });
                }
            })
        }



        function Lectura(img)
        {

            $.ajax({
                type: "POST",
                url: "@Url.Action("Lectura")",
                dataType: "json",
                data: { id:img },
                success: function (d) {
                    if (d.status == true) {
                        $.notify({ message: 'Se actualizo el estado a Lectura' }, { type: 'success' });
                        CargarGrid();
                    }
                    else {

                        $.notify({ message: d.messageerror }, { type: 'danger' });
                    }

                }, error: function (xhr, status, error) {

                    $.notify({ message: status }, { type: 'danger' });
                }
            });
        }
        function Anular(img, pedido)
        {

            $.ajax({
                type: "POST",
                url: "@Url.Action("Anulacion")",
                dataType: "json",
                data: { imagen:img },
                success: function (d) {
                    if (d.status == true) {
                        InsertarTotalImagen(pedido);
                    }
                    else {

                        $.notify({ message: d.messageerror }, { type: 'danger' });
                    }

                }, error: function (xhr, status, error) {

                    $.notify({ message: status }, { type: 'danger' });
                }
            });
        }
        function Transcripcion(imagen)
        {
            @*@Url.Action("Transcripcion", "Imagenologia", new {img="imagen" })*@
             $.ajax({
                type: "POST",
                url: "@Url.Action("Transcripcion")",
                dataType: "json",
                data: { imagen:imagen },
                success: function (d) {
                    if (d.status == true) {

                        if (d.pantalla == 'NUEVO') { window.location.href = '/Imagenologia/Transcripcion_Nueva?id=' + imagen }
                        else if (d.pantalla == 'REPORTE') { window.open('/Imagenologia/rptEstudioImagen?img=' + imagen, '_blank'); }
                    }
                    else {

                        $.notify({ message: d.messageerror }, { type: 'danger' });
                    }

                }, error: function (xhr, status, error) {

                    $.notify({ message: status }, { type: 'danger' });
                }
            });
        }
    </script>


}




